# Coze 工作流调用脚本使用说明

本文档说明如何使用 Coze 工作流 API 调用脚本。

## 文件说明

- `workflow_sync.py` - 同步执行工作流脚本
- `workflow_async.py` - 异步执行工作流并轮询结果脚本
- `requirements.txt` - Python 依赖包列表

## 环境准备

### 1. 安装 Python 依赖

```bash
pip install -r requirements.txt
```

或者直接安装：

```bash
pip install requests
```

## 使用步骤

### 方式一：使用同步执行脚本（workflow_sync.py）

**适用场景**：工作流执行时间较短（建议不超过 5 分钟），需要立即获取结果。

**使用步骤**：

1. 打开 `workflow_sync.py` 文件
2. 在脚本顶部的配置区域填写以下信息：
   ```python
   YOUR_ACCESS_TOKEN = "your_actual_access_token"
   WORKFLOW_ID = "your_actual_workflow_id"
   INPUTS = {
       "param1": "value1",
       "param2": "value2"
   }
   ```
3. 运行脚本：
   ```bash
   python workflow_sync.py
   ```
4. 脚本会：
   - 发送同步执行请求
   - 等待工作流执行完成
   - 在控制台显示完整结果
   - 自动保存结果到 JSON 文件（文件名格式：`{run_id}_{created_at}.json`）

### 方式二：使用异步执行脚本（workflow_async.py）

**适用场景**：工作流执行时间较长，或希望异步处理。

**使用步骤**：

1. 打开 `workflow_async.py` 文件
2. 在脚本顶部的配置区域填写以下信息：
   ```python
   YOUR_ACCESS_TOKEN = "your_actual_access_token"
   WORKFLOW_ID = "your_actual_workflow_id"
   INPUTS = {
       "param1": "value1",
       "param2": "value2"
   }
   ```
3. （可选）调整轮询配置：
   ```python
   INITIAL_POLL_INTERVAL = 2    # 初始轮询间隔（秒）
   MAX_POLL_INTERVAL = 30       # 最大轮询间隔（秒）
   MAX_POLL_ATTEMPTS = 120      # 最大轮询次数
   ```
4. 运行脚本：
   ```bash
   python workflow_async.py
   ```
5. 脚本会：
   - 发送异步执行请求，获取 `run_id`
   - 自动轮询任务状态（使用指数退避策略）
   - 在控制台实时显示轮询进度和状态
   - 任务完成后，显示完整结果
   - 自动保存结果到 JSON 文件（文件名格式：`{run_id}_{created_at}.json`）

## 配置说明

### 必需配置

- **YOUR_ACCESS_TOKEN**：您的 Coze API 访问令牌
- **WORKFLOW_ID**：要执行的工作流 ID
- **INPUTS**：工作流所需的输入参数（字典格式）

### 可选配置（仅 workflow_async.py）

- **INITIAL_POLL_INTERVAL**：初始轮询间隔（秒），默认 2 秒
- **MAX_POLL_INTERVAL**：最大轮询间隔（秒），默认 30 秒
- **MAX_POLL_ATTEMPTS**：最大轮询次数，默认 120 次

## 输出文件

两个脚本都会自动保存结果到 JSON 文件，文件命名规则：

- **格式**：`{run_id}_{created_at}.json`
- **示例**：`run123_20251028T155840.json`

文件包含工作流的完整返回信息，包括：
- `run_id`：运行 ID
- `workflow_id`：工作流 ID
- `status`：执行状态
- `inputs`：输入参数
- `outputs`：输出结果（成功时）
- `error`：错误信息（失败时）
- `created_at`：创建时间
- `updated_at`：更新时间

## 状态说明

工作流执行状态可能的值：
- **pending**：任务已创建，等待执行
- **running**：任务正在执行中
- **completed**：任务执行成功完成
- **failed**：任务执行失败

## 错误处理

脚本已包含错误处理机制：
- HTTP 错误会显示详细的错误信息
- 网络异常会自动处理
- JSON 解析错误会显示原始响应

## 注意事项

1. **Token 安全**：请妥善保管您的 Access Token，不要提交到版本控制系统
2. **超时设置**：
   - 同步脚本默认超时为 5 分钟
   - 长时间运行的工作流建议使用异步脚本
3. **轮询策略**：异步脚本使用指数退避策略，避免频繁请求
4. **输入参数**：确保 `INPUTS` 中的参数名称与工作流定义中的输入参数名称一致

## 示例输出

### 同步执行脚本输出示例

```
============================================================
Coze 工作流同步执行
============================================================
工作流 ID: your_workflow_id
输入参数: {
  "param1": "value1",
  "param2": "value2"
}
------------------------------------------------------------
正在发送请求...

请求成功！
============================================================
响应结果:
{
  "run_id": "run123",
  "status": "completed",
  "output": {
    "result": "success"
  },
  "created_at": "2025-10-28T15:58:40Z",
  "updated_at": "2025-10-28T15:59:00Z"
}
============================================================

结果已保存到文件: run123_20251028T155840.json

执行状态: completed
输出结果: {
  "result": "success"
}
```

### 异步执行脚本输出示例

```
============================================================
启动 Coze 工作流异步执行
============================================================
工作流 ID: your_workflow_id
输入参数: {
  "param1": "value1",
  "param2": "value2"
}
------------------------------------------------------------
正在发送异步执行请求...

异步任务已启动！
------------------------------------------------------------
启动响应:
{
  "run_id": "run123",
  "status": "pending",
  "created_at": "2025-10-28T15:58:40Z"
}

任务 ID (run_id): run123
初始状态: pending
============================================================

开始轮询任务状态...
------------------------------------------------------------

第 1 次查询... (等待 2 秒)
当前状态: running
更新时间: 2025-10-28T15:58:42Z
任务正在执行中...

第 2 次查询... (等待 2 秒)
当前状态: completed

任务执行完成！
============================================================
完整执行结果:
============================================================
{
  "run_id": "run123",
  "workflow_id": "your_workflow_id",
  "status": "completed",
  "inputs": {
    "param1": "value1",
    "param2": "value2"
  },
  "outputs": {
    "result": "success"
  },
  "created_at": "2025-10-28T15:58:40Z",
  "updated_at": "2025-10-28T16:00:00Z"
}
============================================================

结果已保存到文件: run123_20251028T155840.json

最终状态: completed

输出结果:
{
  "result": "success"
}

============================================================
执行完成！
============================================================
```

## 常见问题

**Q: 如何获取 Access Token？**  
A: 通过 Coze 平台的 OAuth 机制获取，具体方法请参考 Coze 官方文档。

**Q: 如何获取 Workflow ID？**  
A: 在 Coze 平台创建工作流后，可以在工作流详情页面找到 ID。

**Q: 同步执行超时怎么办？**  
A: 可以修改脚本中的 `timeout` 参数，或者改用异步执行脚本。

**Q: 异步任务一直处于 pending 状态？**  
A: 检查工作流配置是否正确，或增加 `MAX_POLL_ATTEMPTS` 的值。

---

如有问题，请参考 [Coze工作流API调用说明.md](./Coze工作流API调用说明.md) 了解详细的 API 规范。

